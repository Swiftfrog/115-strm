def fetch_html_with_selenium(url, driver, max_retries=3):
    """
    使用 Selenium 获取页面 HTML 内容，并智能等待页面加载完成。
    """
    for attempt in range(1, max_retries + 1):
        try:
            debug_log(f"第 {attempt} 次尝试：访问页面: {url}")
            driver.get(url)

            # 尝试点击按钮（如果存在）
            try:
                wait = WebDriverWait(driver, 5)  # 等待按钮加载
                enter_button = wait.until(EC.element_to_be_clickable((By.CLASS_NAME, "enter-btn")))
                enter_button.click()
                debug_log("按钮已成功点击")
            except Exception as e:
                debug_log(f"未找到或无法点击按钮: {e}")

            # 等待页面内容加载完成
            try:
                wait = WebDriverWait(driver, 10)
                wait.until(EC.presence_of_all_elements_located((By.CSS_SELECTOR, "tbody[id^='normalthread_'] a[href*='thread-']")))
                debug_log("页面内容已加载完成")
                html_content = driver.page_source
                debug_log(f"成功提取页面 HTML 内容，长度为 {len(html_content)} 字节。")
                return html_content
            except Exception as e:
                debug_log(f"页面内容加载失败: {e}")

            # 如果按钮和页面内容都加载失败，则重新加载页面
            debug_log("按钮和页面内容均加载失败，准备重新加载页面...")
            continue

        except Exception as e:
            debug_log(f"页面加载失败: {e}")
            if attempt == max_retries:
                debug_log("达到最大重试次数，放弃加载页面。")
                return None
